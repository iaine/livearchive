<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reading of NIN Live Archive</title>

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <style> 
    body {
        background-color: black;
        font-family: Arial, sans-serif;
    }
    p {
        color: antiquewhite;
    }
    </style>
</head>
<body>
<p>NIN Catalogue prototype</p>
<button id="resetBtn">Reset Graph</button>
<p>Microphone</p>
<select id="microphone">
  <option value="CA">CA</option>
  <option value="Schoeps">Schoeps</option>
  <option value="Dynamic Audio Binaurals">Dynamic Audio</option>
  <option value="Core Sound">Core Sound </option>
  <option value="Church Audio">Church Audio</option>
  <option value="Canon">Canon</option>
</select>
<button id="updateBtn">Select Microphone</button>

<p>Sound</p>
<select id="sound">
  <option value="binaural">binaural</option>
  <option value="stereo" >stereo</option>
  <option value="cardoid">cardoid</option>
</select>
<button id="updateSndBtn">Select Sound</button>



<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script> 
var svg;
function initialgraph() {
    // set the dimensions and margins of the graph
    const margin = {top: 30, right: 30, bottom: 70, left: 60},
        width = 1380 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    svg = d3.select("#my_dataviz")
    .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    let y;
    let x;

    var xAxis;
    var yAxis;

    // Parse the Data
    d3.csv("dates.csv").then( function(data) {

        // X axis
        x = d3.scaleBand()
        .range([ 0, width ])
        .domain(data.map(d => d.date))
        .padding(0.2);

        xAxis = svg.append("g")
        .attr("transform", `translate(0, ${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", 12)
            .style("fill", "#f8f8ff");



        // Add Y axis
        y = d3.scaleLinear()
        .domain([0, 30])
        .range([ height, 0]);
        yAxis = svg.append("g")
        .call(d3.axisLeft(y))
        .selectAll("text")
            .style("font-size", 12)
            .style("fill", "#f8f8ff")
        .selectAll("line")
            .style("font-size", 12)
            .style("fill", "#f8f8ff");

        // Bars
        svg.selectAll("mybar")
        .data(data)
        .join("rect")
            .attr("x", d => x(d.date))
            .attr("y", d => y(d.event))
            .attr("width", 2) //x.bandwidth()
            .attr("height", d => d.event)
            .attr("fill", "#f8f8ff")

    })

}
initialgraph();

document.getElementById('resetBtn').addEventListener('click', () => {
    initialgraph();
});

document.getElementById('updateBtn').addEventListener('click', () => {
    const e = document.getElementById("microphone");
    const value = e.value;
    const text = e.options[e.selectedIndex].text;

    let _data = {};
    let data = [];
    async function getData() {
        const url = "dates.json";
        try {
            const response = await fetch(url);
            if (!response.ok) {
             throw new Error(`Response status: ${response.status}`);
            }

            const result = await response.json();
            result.forEach(element => {
                if (element['microphone'].includes(text)) { 
                    _data[element["date"]] = (_data[element["date"]] || 0) + 1;
                }
            });

            for (let [key, value] of Object.entries(_data)) {
                data.push({"date":key, "event":value});
            }

            var u = svg.selectAll("rect").attr("opacity", .4)
                .data(data)

                u
                .enter()
                .append("rect")
                .merge(u)
                .transition()
                .duration(1000)
                    .attr("x", function(d) { return x(d.date); })
                    .attr("y", function(d) { return y(d.event); })
                    .attr("width", 2) //x.bandwidth()
                    .attr("height", d => d.event)
                    .attr("fill", "#69b3a2")
                    .attr("opacity", 1)
            
        } catch (error) {
            console.error(error.message);
        }
    }
    getData();
});

document.getElementById('updateSndBtn').addEventListener('click', () => {
    const e = document.getElementById("sound");
    const value = e.value;
    const text = e.options[e.selectedIndex].text;

    let _data = {};
    let data = [];
    async function getData() {
        const url = "dates.json";
        try {
            const response = await fetch(url);
            if (!response.ok) {
             throw new Error(`Response status: ${response.status}`);
            }

            const result = await response.json();
            result.forEach(element => {
                if (element['audio'].includes(text)) { 
                    _data[element["date"]] = (_data[element["date"]] || 0) + 1;
                }
            });

            for (let [key, value] of Object.entries(_data)) {
                data.push({"date":key, "event":value});
            }

            var u = svg.selectAll("rect").attr("opacity",.4)
                .data(data)

                u
                .enter()
                .append("rect")
                .merge(u)
                .transition()
                .duration(1000)
                    .attr("x", function(d) { return x(d.date); })
                    .attr("y", function(d) { return y(d.event); })
                    .attr("width", x.bandwidth())
                    .attr("height", d => d.event)
                    .attr("fill", "#69b3a2")
            
        } catch (error) {
            console.error(error.message);
        }
    }
    getData();

});
</script>

</body>

</html>